name: Build and Release SQL2API

on:
  push:
    tags:
      - 'v*.*.*'  # å½“æ¨é€ v1.0.0 æ ¼å¼çš„æ ‡ç­¾æ—¶è§¦å‘
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘
    inputs:
      version:
        description: 'Release version (e.g., v1.0.0)'
        required: true
        default: 'v1.0.0'

env:
  GO_VERSION: '1.24'
  APP_NAME: 'sql2api'

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: ${{ env.GO_VERSION }}

    - name: Set up build tools
      run: |
        sudo apt-get update
        sudo apt-get install -y upx-ucl

    - name: Cache Go modules
      uses: actions/cache@v4
      with:
        path: |
          ~/go/pkg/mod
          ~/.cache/go-build
        key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
        restore-keys: |
          ${{ runner.os }}-go-



    - name: Install Go dependencies
      run: |
        go mod download
        go mod tidy

    - name: Generate Swagger docs
      run: |
        go install github.com/swaggo/swag/cmd/swag@latest
        swag init -g cmd/server/main.go -o docs

    - name: Run tests
      run: |
        go test -v ./...

    - name: Build binaries for multiple platforms
      run: |
        # Create build directory
        mkdir -p build

        # Set build variables
        VERSION="${{ github.ref_name || inputs.version }}"
        BUILD_TIME=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
        GIT_COMMIT="${{ github.sha }}"
        LDFLAGS="-s -w -X main.version=${VERSION} -X main.buildTime=${BUILD_TIME} -X main.gitCommit=${GIT_COMMIT}"

        echo "Building SQL2API ${VERSION}"
        echo "Build Time: ${BUILD_TIME}"
        echo "Git Commit: ${GIT_COMMIT}"

        # Build for Linux AMD64
        echo "Building for Linux AMD64..."
        CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build \
          -ldflags="${LDFLAGS}" \
          -o build/${APP_NAME}-linux-amd64 \
          cmd/server/main.go

        # Build for Linux ARM64
        echo "Building for Linux ARM64..."
        CGO_ENABLED=0 GOOS=linux GOARCH=arm64 go build \
          -ldflags="${LDFLAGS}" \
          -o build/${APP_NAME}-linux-arm64 \
          cmd/server/main.go

        # Build for Windows AMD64
        echo "Building for Windows AMD64..."
        CGO_ENABLED=0 GOOS=windows GOARCH=amd64 go build \
          -ldflags="${LDFLAGS}" \
          -o build/${APP_NAME}-windows-amd64.exe \
          cmd/server/main.go

        # Build for macOS AMD64
        echo "Building for macOS AMD64..."
        CGO_ENABLED=0 GOOS=darwin GOARCH=amd64 go build \
          -ldflags="${LDFLAGS}" \
          -o build/${APP_NAME}-darwin-amd64 \
          cmd/server/main.go

        # Build for macOS ARM64 (Apple Silicon)
        echo "Building for macOS ARM64..."
        CGO_ENABLED=0 GOOS=darwin GOARCH=arm64 go build \
          -ldflags="${LDFLAGS}" \
          -o build/${APP_NAME}-darwin-arm64 \
          cmd/server/main.go

        # Display build results
        echo "Build completed successfully!"
        ls -la build/

    - name: Compress binaries with UPX
      run: |
        # Compress Linux binaries
        upx --best --lzma build/${APP_NAME}-linux-amd64
        upx --best --lzma build/${APP_NAME}-linux-arm64

        # Compress Windows binary
        upx --best --lzma build/${APP_NAME}-windows-amd64.exe

        # Note: UPX doesn't work well with macOS binaries, so we skip them

    - name: Create distribution packages
      run: |
        mkdir -p dist

        # Copy configuration files
        cp config.yaml dist/
        cp README.md dist/
        cp -r examples dist/

        # Create Linux AMD64 package
        mkdir -p dist/linux-amd64
        cp build/${APP_NAME}-linux-amd64 dist/linux-amd64/${APP_NAME}
        cp config.yaml dist/linux-amd64/
        cp README.md dist/linux-amd64/
        cp -r examples dist/linux-amd64/
        cd dist && tar -czf ${APP_NAME}-linux-amd64.tar.gz linux-amd64/ && cd ..

        # Create Linux ARM64 package
        mkdir -p dist/linux-arm64
        cp build/${APP_NAME}-linux-arm64 dist/linux-arm64/${APP_NAME}
        cp config.yaml dist/linux-arm64/
        cp README.md dist/linux-arm64/
        cp -r examples dist/linux-arm64/
        cd dist && tar -czf ${APP_NAME}-linux-arm64.tar.gz linux-arm64/ && cd ..

        # Create Windows package
        mkdir -p dist/windows-amd64
        cp build/${APP_NAME}-windows-amd64.exe dist/windows-amd64/${APP_NAME}.exe
        cp config.yaml dist/windows-amd64/
        cp README.md dist/windows-amd64/
        cp -r examples dist/windows-amd64/
        cd dist && zip -r ${APP_NAME}-windows-amd64.zip windows-amd64/ && cd ..

        # Create macOS AMD64 package
        mkdir -p dist/darwin-amd64
        cp build/${APP_NAME}-darwin-amd64 dist/darwin-amd64/${APP_NAME}
        cp config.yaml dist/darwin-amd64/
        cp README.md dist/darwin-amd64/
        cp -r examples dist/darwin-amd64/
        cd dist && tar -czf ${APP_NAME}-darwin-amd64.tar.gz darwin-amd64/ && cd ..

        # Create macOS ARM64 package
        mkdir -p dist/darwin-arm64
        cp build/${APP_NAME}-darwin-arm64 dist/darwin-arm64/${APP_NAME}
        cp config.yaml dist/darwin-arm64/
        cp README.md dist/darwin-arm64/
        cp -r examples dist/darwin-arm64/
        cd dist && tar -czf ${APP_NAME}-darwin-arm64.tar.gz darwin-arm64/ && cd ..

    - name: Create checksums
      run: |
        cd dist
        for file in *.tar.gz *.zip; do
          sha256sum "$file" > "$file.sha256"
        done

    - name: Determine version
      id: version
      run: |
        if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
          echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
        else
          echo "version=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
        fi

    - name: Get build date
      id: build_date
      run: echo "date=$(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_OUTPUT

    - name: Create Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ steps.version.outputs.version }}
        name: SQL2API ${{ steps.version.outputs.version }}
        body: |
          ## SQL2API ${{ steps.version.outputs.version }}

          ğŸš€ **æ–°ç‰ˆæœ¬å‘å¸ƒ**

          SQL2API æ˜¯ä¸€ä¸ªå¼ºå¤§çš„ API æœåŠ¡å™¨ï¼Œå°† SQL æ“ä½œè½¬æ¢ä¸º REST ç«¯ç‚¹ï¼Œæ”¯æŒ PostgreSQL å’Œ Oracle æ•°æ®åº“ã€‚

          ### âœ¨ ä¸»è¦ç‰¹æ€§

          - ğŸ” **å¼ºå¤§çš„ SQL å¼•æ“**ï¼šæ”¯æŒåŸç”Ÿ SQLã€ç»“æ„åŒ–æŸ¥è¯¢ã€æ‰¹é‡æ“ä½œ
          - ğŸ›¡ï¸ **å¤šå±‚å®‰å…¨é˜²æŠ¤**ï¼šSQL æ³¨å…¥é˜²æŠ¤ã€æƒé™æ§åˆ¶ã€è¡¨ç™½åå•
          - âš¡ **æ‰¹é‡æ“ä½œ**ï¼šæ”¯æŒäº‹åŠ¡å’Œéäº‹åŠ¡æ¨¡å¼çš„æ‰¹é‡ SQL æ“ä½œ
          - ğŸ“ˆ **æ€§èƒ½ç›‘æ§**ï¼šå†…ç½®æŸ¥è¯¢æ€§èƒ½ç›‘æ§å’Œæ…¢æŸ¥è¯¢æ£€æµ‹
          - ğŸ” **API Key è®¤è¯**ï¼šæ”¯æŒç»†ç²’åº¦æƒé™æ§åˆ¶
          - ğŸ“Š **å¤šæ•°æ®åº“æ”¯æŒ**ï¼šPostgreSQL å’Œ Oracle
          - ğŸ“ **å®Œæ•´æ–‡æ¡£**ï¼šSwagger UI å’Œè¯¦ç»†ä½¿ç”¨ç¤ºä¾‹

          ### ğŸ“¦ ä¸‹è½½è¯´æ˜

          é€‰æ‹©é€‚åˆä½ çš„æ“ä½œç³»ç»Ÿçš„ç‰ˆæœ¬ï¼š

          - **Windows (x64)**: `sql2api-windows-amd64.zip`
          - **macOS (Intel)**: `sql2api-darwin-amd64.tar.gz`
          - **macOS (Apple Silicon)**: `sql2api-darwin-arm64.tar.gz`
          - **Linux (x64)**: `sql2api-linux-amd64.tar.gz`
          - **Linux (ARM64)**: `sql2api-linux-arm64.tar.gz`
          
          ### ğŸ› ï¸ å¿«é€Ÿå¼€å§‹

          1. ä¸‹è½½å¯¹åº”å¹³å°çš„å‹ç¼©åŒ…å¹¶è§£å‹
          2. é…ç½® `config.yaml` æ–‡ä»¶ï¼ˆæ•°æ®åº“è¿æ¥ã€API Keys ç­‰ï¼‰
          3. ç»™äºŒè¿›åˆ¶æ–‡ä»¶æ·»åŠ æ‰§è¡Œæƒé™ï¼ˆLinux/macOSï¼‰: `chmod +x sql2api`
          4. è¿è¡Œ: `./sql2api` æˆ– `sql2api.exe`ï¼ˆWindowsï¼‰
          5. è®¿é—® Swagger UI: http://localhost:8080/swagger/index.html

          ### ğŸ”§ é…ç½®è¯´æ˜

          - é…ç½®æ•°æ®åº“è¿æ¥ï¼ˆPostgreSQL æˆ– Oracleï¼‰
          - è®¾ç½® API Keys å’Œæƒé™
          - é…ç½®å…è®¸è®¿é—®çš„è¡¨å’Œæ“ä½œ
          - è°ƒæ•´æŸ¥è¯¢è¶…æ—¶å’Œç»“æœé›†å¤§å°é™åˆ¶

          ### ğŸ“š API ç«¯ç‚¹

          - `POST /api/v1/sql` - é€šç”¨ SQL æŸ¥è¯¢
          - `POST /api/v1/sql/batch` - æ‰¹é‡ SQL æ“ä½œ
          - `POST /api/v1/sql/insert` - ä¾¿æ·æ’å…¥
          - `POST /api/v1/sql/batch-insert` - æ‰¹é‡æ’å…¥
          
          ### ğŸ” æ ¡éªŒå’Œ
          
          æ¯ä¸ªäºŒè¿›åˆ¶æ–‡ä»¶éƒ½é™„å¸¦äº† SHA256 æ ¡éªŒå’Œæ–‡ä»¶ï¼ˆ.sha256ï¼‰ï¼Œç”¨äºéªŒè¯æ–‡ä»¶å®Œæ•´æ€§ã€‚
          
          ---
          
          ğŸ“… æ„å»ºæ—¶é—´: ${{ steps.build_date.outputs.date }}
          ğŸ—ï¸ æ„å»ºç¯å¢ƒ: GitHub Actions
        files: |
          dist/sql2api-windows-amd64.zip
          dist/sql2api-windows-amd64.zip.sha256
          dist/sql2api-darwin-amd64.tar.gz
          dist/sql2api-darwin-amd64.tar.gz.sha256
          dist/sql2api-darwin-arm64.tar.gz
          dist/sql2api-darwin-arm64.tar.gz.sha256
          dist/sql2api-linux-amd64.tar.gz
          dist/sql2api-linux-amd64.tar.gz.sha256
          dist/sql2api-linux-arm64.tar.gz
          dist/sql2api-linux-arm64.tar.gz.sha256
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Show build summary
      run: |
        echo "ğŸ‰ Build completed successfully!"
        echo "ğŸ“¦ Release: ${{ steps.version.outputs.version }}"
        echo "ğŸ—ï¸ Built files:"
        ls -lh dist/
